<!DOCTYPE html>
<html>
<head>
	<title>Client</title>
	<style type="text/css">

		:root {
		  --dark1: #202529;
		  --dark2: #32383D;
		  --light1: #4C555C;
		  --light2: #A1B4C4;
		  --accent: #48C79A;
		  --warning: #C73B32;
		}

		body {
			margin: 0;
			padding:0;
			background-color: #202529;
			box-sizing: border-box;
			color: white;
		}

		#main_container {
			width: 100%;
			height: 100vh;
			background-color: var(--light1);
			color: white;
			font-family: sans-serif;
			font-size: 18px;
		}

		.header {
			width: 100%;
			text-align: center;
			padding: 10px;
			box-sizing: border-box;
			background-color: var(--dark2);
			box-shadow: 0 0px 10px rgba(0,0,0,0.5);
			z-index: 100;
			margin-bottom: 20px;
		}

		a {
			color: #99f;
		}

		#image_wrapper {
			width: 100%;
			min-height: 200px;
			text-align: center;
		}

		#img_viewer {
			width: 100%;
			max-width: 100%;
			max-height: 100%;
			vertical-align: middle;
		}

		button {
			background-color: var(--accent);
			border: none;
			color: black;
			padding: 6px;
			min-width: 150px;
			box-shadow: 0 0px 10px rgba(0,0,0,0.5);
		}

		button:active {
			background-color: var(--warning);
			box-shadow: 0 0px 3px rgba(0,0,0,0.5);
		}

		#footer {
			position: fixed;
			bottom: 0;
			left:0;
			width: 100%;
			box-sizing: border-box;
			background-color: var(--dark2);
			padding:10px;
			box-shadow: 0 0px 10px rgba(0,0,0,0.5);
			line-height: 28px;
		}

		.footer_line {
			width: 100%;
			margin-top: 5px;
			margin-bottom: 5px;
		}

		#debug_log {
			min-width: 50%;
			height: 300px;
			font-family: monospace;
			font-size: 14px;
			background-color: var(--dark1);
			padding:10px;
			overflow-y: scroll;
		}

		.center {
			text-align: center;
		}
	</style>
</head>
<body>
	<div id="main_container">
		<div class="header">PiSpeedCam Control Panel v0.1.0 <a style="font-size:10px" href="https://github.com/ElvinC/PiSpeedCam">source code</a></div>
		<div id="image_wrapper">
			Preview:
			<img id="img_viewer" src="">
		</div>
		<div class="center">Debug log:</div>
		<div id="debug_log"></div>
		<div id="footer">
			<div class="footer_line">Record time (ms)
				<input id="setting_record_len" type="number" value="5000">
				<button id="capture_btn">Capture!</button>
				<button>Preview last recording</button>
				<button>Transfer last recording</button>
			</div>		
			<div class="footer_line">
				Skip frames: <input type="number" value="1" id="setting_skip_frame">
				FPS: <input type="number" value="10" id="setting_playback_fps" min="1" max="25">
				<button id="send_config_btn">Apply</button>
			</div>
		</div>

	</div>

</body>
<script type="text/javascript">
	var ws;
	var connected = false;


	function debug(msg) {
		var date = new Date()
		var ms = String(date.getMilliseconds())
		while (ms.length < 4) {
			ms += "0"
		}
		var timestamp = "<" + date.toISOString().substr(11, 8) + ":"+ ms + "> "
		var DL = document.getElementById("debug_log")
		DL.innerText += "\n" + timestamp + msg;
		

		DL.scrollTop = DL.scrollHeight;
	}
	
	function attempt_reconnect() {
		debug("Attempting to connect...");
		
		ws = new WebSocket("ws://" + location.host + "/websocket/");
		
		ws.onopen = function (event) {
			debug("Connection established!");
			connected = true;
		}
		
		ws.onclose = function (event) {
			debug("Connection closed");
			connected = false;
			
			setTimeout(attempt_reconnect, 5000);
		}
		
		ws.onmessage = function (event) {
			img_viewer.src = event.data;
			//debug("Image received");
		}
	}
	
	document.getElementById("send_config_btn").addEventListener('click', function (event) {
		if (connected) {
			ws.send(JSON.stringify({
				command: "CONFIG",
				skip_frames: parseInt(document.getElementById("setting_skip_frame").value),
				frame_delay: Math.round(1000 / parseInt(document.getElementById("setting_playback_fps").value))
			}))
		}
		debug("Sending config");
	}, false)
	
	document.getElementById("capture_btn").addEventListener('click', function (event) {
		if (connected) {
			ws.send(JSON.stringify({
				command: "CAPTURE",
				record_length: parseInt(document.getElementById("setting_record_len").value)
			}))
		}
		debug("Sending config");
	}, false)
	
	attempt_reconnect();
	
	
	




</script>
</html>
